# Cognito ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¬ã‚¤ãƒ‰

## ãƒ¡ãƒ¼ãƒ«ç¢ºèªæ–¹å¼

Feed Bowerã§ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²æ™‚ã®ãƒ¡ãƒ¼ãƒ«ç¢ºèªã«**URLãƒªãƒ³ã‚¯æ–¹å¼**ã‚’æ¡ç”¨ã—ã¦ã„ã¾ã™ã€‚

### ç¢ºèªæ–¹å¼ã®é•ã„

| æ–¹å¼ | èª¬æ˜ | ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ |
|------|------|------------|
| `CONFIRM_WITH_CODE` | ç¢ºèªã‚³ãƒ¼ãƒ‰ã‚’ãƒ¡ãƒ¼ãƒ«ã§é€ä¿¡ | ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦å…¥åŠ› |
| `CONFIRM_WITH_LINK` | ç¢ºèªãƒªãƒ³ã‚¯ã‚’ãƒ¡ãƒ¼ãƒ«ã§é€ä¿¡ | ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã ã‘ âœ… |

### ç¢ºèªå¾Œã®ç”»é¢é·ç§»

1. **ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—**
   - ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›
   - ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯

2. **ç¢ºèªãƒ¡ãƒ¼ãƒ«ã‚’å—ä¿¡**
   - ä»¶å: "Feed Bower - ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ç¢ºèª"
   - æœ¬æ–‡ã«ç¢ºèªãƒªãƒ³ã‚¯ãŒå«ã¾ã‚Œã‚‹

3. **ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯**
   - Cognitoã®ç¢ºèªå®Œäº†ãƒšãƒ¼ã‚¸ã«é·ç§»
   - "Your email has been verified successfully" ã¨è¡¨ç¤ºã•ã‚Œã‚‹

4. **ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹**
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯æ‰‹å‹•ã§ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹
   - ã¾ãŸã¯ã€ã‚«ã‚¹ã‚¿ãƒ ç¢ºèªãƒšãƒ¼ã‚¸ (`/verify-email`) ã‚’ä½¿ç”¨

### Hosted UIã§ã®ç¢ºèª

Feed Bowerã§ã¯ã€**Cognito Hosted UI**ã‚’ä½¿ç”¨ã—ã¦ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã•ã‚ŒãŸç¢ºèªãƒšãƒ¼ã‚¸ã‚’æä¾›ã—ã¾ã™ï¼š

**ç‰¹å¾´**:
- ğŸ¨ Feed Bowerã®ãƒ‡ã‚¶ã‚¤ãƒ³ã«åˆã‚ã›ãŸã‚«ã‚¹ã‚¿ãƒ CSS
- ğŸªº ãƒ–ãƒ©ãƒ³ãƒ‰ãƒ­ã‚´ã¨ã‚«ãƒ©ãƒ¼ï¼ˆ#14b8a6 ãƒ†ã‚£ãƒ¼ãƒ«ï¼‰
- ğŸ“± ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³
- âœ… ç¢ºèªå®Œäº†å¾Œã€è‡ªå‹•çš„ã«ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã¸

**Hosted UI URL**:
```
https://feed-bower-production.auth.ap-northeast-1.amazoncognito.com
```

**ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºå†…å®¹**:
- èƒŒæ™¯: ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆãƒ†ã‚£ãƒ¼ãƒ« â†’ ãƒ›ãƒ¯ã‚¤ãƒˆ â†’ ã‚¢ãƒ³ãƒãƒ¼ï¼‰
- ãƒœã‚¿ãƒ³: ãƒ†ã‚£ãƒ¼ãƒ«ã‚«ãƒ©ãƒ¼ (#14b8a6)
- ãƒ›ãƒãƒ¼: ãƒ€ãƒ¼ã‚¯ã‚°ãƒ¬ãƒ¼ (#505050)
- ãƒ•ã‚©ãƒ³ãƒˆ: ç¾åœ¨ã®ãƒ­ã‚°ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ€ãƒ«ã¨åŒã˜ã‚¹ã‚¿ã‚¤ãƒ«

### ç¾åœ¨ã®è¨­å®š

**Terraformè¨­å®š** (`infra/modules/cognito/main.tf`):
```hcl
verification_message_template {
  default_email_option  = "CONFIRM_WITH_LINK"
  email_subject         = "Feed Bower - Verify your email"
  email_message_by_link = "Welcome to Feed Bower! Please click the link below to verify your email address: {##Verify Email##}"
}
```

## ãƒ‡ãƒ—ãƒ­ã‚¤æ–¹æ³•

### æœ¬ç•ªç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤

```bash
# 1. Terraformãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•
cd infra/environments/production

# 2. åˆæœŸåŒ–ï¼ˆåˆå›ã®ã¿ï¼‰
terraform init

# 3. å¤‰æ›´å†…å®¹ã‚’ç¢ºèª
terraform plan

# 4. ãƒ‡ãƒ—ãƒ­ã‚¤
terraform apply

# 5. Cognitoæƒ…å ±ã‚’ç¢ºèª
terraform output cognito_user_pool_id
terraform output -raw hosted_ui_url
```

**ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã®ç¢ºèª**:
```bash
# Hosted UIã«ã‚¢ã‚¯ã‚»ã‚¹
open "https://feed-bower-production.auth.ap-northeast-1.amazoncognito.com/login?client_id=$(terraform output -raw cognito_client_id)&response_type=code&redirect_uri=https://www.feed-bower.net"
```

### æ—¢å­˜ã®User Poolã‚’æ›´æ–°ã™ã‚‹å ´åˆ

æ—¢ã«User PoolãŒå­˜åœ¨ã™ã‚‹å ´åˆã€Terraformã§æ›´æ–°ã§ãã¾ã™ï¼š

```bash
cd infra/environments/production

# æ—¢å­˜ãƒªã‚½ãƒ¼ã‚¹ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆåˆå›ã®ã¿ï¼‰
terraform import module.cognito.aws_cognito_user_pool.pool ap-northeast-1_xxxxxxxxx

# æ›´æ–°ã‚’é©ç”¨
terraform apply
```

ã¾ãŸã¯ã€AWS CLIã§ç›´æ¥æ›´æ–°ï¼š

```bash
aws cognito-idp update-user-pool \
  --user-pool-id ap-northeast-1_krlr3Seby \
  --verification-message-template '{
    "DefaultEmailOption": "CONFIRM_WITH_LINK",
    "EmailSubject": "Feed Bower - ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ç¢ºèª",
    "EmailMessageByLink": "Feed Bowerã¸ã‚ˆã†ã“ãï¼ä»¥ä¸‹ã®ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„: {##Verify Email##}"
  }' \
  --region ap-northeast-1
```

## ãƒ¡ãƒ¼ãƒ«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º

### æ—¥æœ¬èªãƒ¡ãƒ¼ãƒ«

```hcl
verification_message_template {
  default_email_option  = "CONFIRM_WITH_LINK"
  email_subject         = "Feed Bower - ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ç¢ºèª"
  email_message_by_link = "Feed Bowerã¸ã‚ˆã†ã“ãï¼\n\nä»¥ä¸‹ã®ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„:\n{##Verify Email##}\n\nã“ã®ãƒªãƒ³ã‚¯ã¯24æ™‚é–“æœ‰åŠ¹ã§ã™ã€‚"
}
```

### è‹±èªãƒ¡ãƒ¼ãƒ«

```hcl
verification_message_template {
  default_email_option  = "CONFIRM_WITH_LINK"
  email_subject         = "Feed Bower - Verify your email"
  email_message_by_link = "Welcome to Feed Bower!\n\nPlease click the link below to verify your email address:\n{##Verify Email##}\n\nThis link is valid for 24 hours."
}
```

### HTMLãƒ¡ãƒ¼ãƒ«ï¼ˆã‚«ã‚¹ã‚¿ãƒ SESä½¿ç”¨æ™‚ï¼‰

Cognitoã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¡ãƒ¼ãƒ«ã§ã¯ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®ã¿ã§ã™ãŒã€Amazon SESã‚’ä½¿ç”¨ã™ã‚‹ã¨HTMLãƒ¡ãƒ¼ãƒ«ãŒé€ä¿¡ã§ãã¾ã™ï¼š

```hcl
email_configuration {
  email_sending_account = "DEVELOPER"
  source_arn           = aws_ses_email_identity.feed_bower.arn
  from_email_address   = "noreply@feed-bower.com"
}
```

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ãƒ¡ãƒ¼ãƒ«ãŒå±Šã‹ãªã„

1. **ã‚¹ãƒ‘ãƒ ãƒ•ã‚©ãƒ«ãƒ€ã‚’ç¢ºèª**
   - Cognitoã‹ã‚‰ã®ãƒ¡ãƒ¼ãƒ«ãŒã‚¹ãƒ‘ãƒ ã«åˆ†é¡ã•ã‚Œã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™

2. **ãƒ¡ãƒ¼ãƒ«é€ä¿¡åˆ¶é™**
   - Cognitoã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¡ãƒ¼ãƒ«ã¯1æ—¥50é€šã¾ã§
   - æœ¬ç•ªç’°å¢ƒã§ã¯SESã®ä½¿ç”¨ã‚’æ¨å¥¨

3. **ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ç¢ºèª**
   - `auto_verified_attributes = ["email"]`ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª

### ãƒªãƒ³ã‚¯ãŒç„¡åŠ¹

1. **ãƒªãƒ³ã‚¯ã®æœ‰åŠ¹æœŸé™**
   - ç¢ºèªãƒªãƒ³ã‚¯ã¯24æ™‚é–“æœ‰åŠ¹
   - æœŸé™åˆ‡ã‚Œã®å ´åˆã¯å†é€ä¿¡ãŒå¿…è¦

2. **User Poolè¨­å®šã®ç¢ºèª**
   ```bash
   aws cognito-idp describe-user-pool \
     --user-pool-id ap-northeast-1_krlr3Seby \
     --region ap-northeast-1 \
     --query 'UserPool.VerificationMessageTemplate'
   ```

### ç¢ºèªã‚³ãƒ¼ãƒ‰æ–¹å¼ã«æˆ»ã—ãŸã„å ´åˆ

```bash
# Terraform
# infra/modules/cognito/main.tf ã‚’ç·¨é›†
verification_message_template {
  default_email_option = "CONFIRM_WITH_CODE"
  email_subject        = "Feed Bower - Verify your email"
  email_message        = "Your verification code is: {####}"
}

# terraform apply ã§é©ç”¨
```

## ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒï¼ˆMagnetoï¼‰

ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒã§ã¯ã€MagnetoãŒè‡ªå‹•çš„ã«ãƒ¡ãƒ¼ãƒ«ç¢ºèªã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚

è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«: `front/src/lib/cognito-client.ts`
```typescript
// ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºæ™‚ã¯è‡ªå‹•ç¢ºèª
if (isLocalDevelopment) {
  await this.confirmSignUp(username, "123456");
}
```

## ã‚«ã‚¹ã‚¿ãƒ ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã®è¨­å®šï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

ç¢ºèªãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå¾Œã€ã‚«ã‚¹ã‚¿ãƒ ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹ã«ã¯ã€ä»¥ä¸‹ã®æ–¹æ³•ãŒã‚ã‚Šã¾ã™ï¼š

### æ–¹æ³•1: Hosted UIã‚’ä½¿ç”¨

```hcl
# infra/modules/cognito/main.tf
resource "aws_cognito_user_pool_domain" "domain" {
  domain       = "feed-bower-${var.environment}"
  user_pool_id = aws_cognito_user_pool.pool.id
}

# Hosted UIã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º
resource "aws_cognito_user_pool_ui_customization" "ui" {
  user_pool_id = aws_cognito_user_pool.pool.id
  
  css = <<CSS
    .banner-customizable {
      background-color: #14b8a6;
    }
  CSS
}
```

### æ–¹æ³•2: ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’ä½¿ç”¨

ç‹¬è‡ªãƒ‰ãƒ¡ã‚¤ãƒ³ã§ãƒ›ã‚¹ãƒˆã™ã‚‹å ´åˆï¼š

```hcl
resource "aws_cognito_user_pool_domain" "custom" {
  domain          = "auth.feed-bower.com"
  certificate_arn = aws_acm_certificate.cert.arn
  user_pool_id    = aws_cognito_user_pool.pool.id
}
```

### æ–¹æ³•3: Lambda Triggerã§ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ

Post Confirmation Triggerã‚’ä½¿ç”¨ã—ã¦ã€ç¢ºèªå¾Œã®å‡¦ç†ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºï¼š

```javascript
exports.handler = async (event) => {
  // ç¢ºèªå®Œäº†å¾Œã®å‡¦ç†
  console.log('User confirmed:', event.userName);
  
  // ã‚«ã‚¹ã‚¿ãƒ ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆURLã‚’è¨­å®š
  event.response.redirectUrl = 'https://feed-bower.com/verify-email?success=true';
  
  return event;
};
```

## ç¾åœ¨ã®å‹•ä½œ

ç¾åœ¨ã®è¨­å®šã§ã¯ï¼š

1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—
2. ç¢ºèªãƒ¡ãƒ¼ãƒ«ã‚’å—ä¿¡
3. ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ â†’ **Cognitoã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒšãƒ¼ã‚¸ã«é·ç§»**
4. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ‰‹å‹•ã§ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹

å°†æ¥çš„ã«ã¯ã€ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚„Hosted UIã‚’ä½¿ç”¨ã—ã¦ã€ã‚ˆã‚Šã‚·ãƒ¼ãƒ ãƒ¬ã‚¹ãªä½“é¨“ã‚’æä¾›ã§ãã¾ã™ã€‚

## å‚è€ƒãƒªãƒ³ã‚¯

- [AWS Cognito - Email Verification](https://docs.aws.amazon.com/cognito/latest/developerguide/user-pool-settings-email-phone-verification.html)
- [AWS Cognito - Hosted UI](https://docs.aws.amazon.com/cognito/latest/developerguide/cognito-user-pools-app-integration.html)
- [Terraform - aws_cognito_user_pool](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/cognito_user_pool)
- [Magneto - Cognito Emulator](https://github.com/frouriojs/magnito)

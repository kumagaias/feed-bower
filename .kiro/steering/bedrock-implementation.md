# Bedrock Agent統合の実装ガイドライン

## 重要なルール

**Bedrock Agent統合を実装する際は、以下のガイドラインに従うこと**

### 実装の原則

1. **段階的な実装**
   - タスクリストの順序に従って実装する
   - 各タスク完了後、必ず確認項目をチェックする
   - 次のタスクに進む前に、前のタスクが完全に動作することを確認する

2. **テストの実施**
   - Lambda関数: ローカルでテスト実行してから デプロイ
   - Terraform: `terraform plan`でエラーがないことを確認してから`apply`
   - Go コード: `go vet ./...`と`go test ./...`を実行
   - 統合テスト: AWS CLI経由とAPI経由の両方でテスト

3. **フォールバック機構**
   - Bedrock Agentが失敗しても、必ず静的マッピングにフォールバックする
   - フォールバック使用時は必ずログに記録する
   - エンドユーザーにBedrockのエラーを公開しない

4. **ログ記録**
   - すべてのBedrock呼び出しをログに記録
   - 成功時: フィード数、レイテンシ
   - 失敗時: エラー詳細、フォールバック使用
   - パフォーマンスメトリクス: レスポンス時間

5. **エラーハンドリング**
   - タイムアウト: 10秒
   - Bedrockエラー: 自動フォールバック
   - Lambda エラー: 適切なエラーメッセージ
   - 入力検証: 無効なパラメータは400エラー

### 確認項目チェックリスト

各タスク完了後、以下を確認：

#### タスク1: Lambda関数
- [ ] Lambda関数がローカルで正常に動作する
- [ ] フィードデータベースに20件以上のフィードがある
- [ ] 関連度スコアが正しく計算される
- [ ] 入力検証が機能する

#### タスク2: Terraformモジュール
- [ ] `terraform plan`がエラーなく実行できる
- [ ] IAMロールが正しく定義されている
- [ ] Lambda関数がzipファイルとしてパッケージ化されている

#### タスク3: Bedrock Agent設定
- [ ] `terraform plan`でBedrock Agentリソースが表示される
- [ ] APIスキーマが正しく定義されている
- [ ] IAM権限が適切に設定されている

#### タスク4: 本番環境統合
- [ ] `terraform apply`が成功する
- [ ] AWS ConsoleでBedrock Agentが確認できる
- [ ] `terraform output`でAgent IDとAlias IDが表示される
- [ ] 環境変数が正しく設定されている

#### タスク5: Feed Service統合
- [ ] `go vet ./...`がエラーなく実行できる
- [ ] `go test ./...`がすべてパスする
- [ ] Bedrockクライアントが正しく初期化される
- [ ] フォールバック機構が実装されている

#### タスク6: ログ追加
- [ ] Bedrock呼び出しがログに記録される
- [ ] 成功レスポンスがログに記録される
- [ ] フォールバック使用がログに記録される
- [ ] パフォーマンスメトリクスがログに記録される

#### タスク7: デプロイとテスト
- [ ] Dockerイメージがビルドできる
- [ ] Lambda関数がデプロイされる
- [ ] AWS CLI経由でBedrock Agentをテストできる
- [ ] API経由でフィード推奨をテストできる
- [ ] フォールバック機構が動作する
- [ ] レスポンス時間が10秒以内

### トラブルシューティング

#### Bedrock Agentが応答しない
1. CloudWatchログを確認
2. IAM権限を確認
3. Agent IDとAlias IDが正しいか確認
4. タイムアウト設定を確認

#### Lambda関数がエラーを返す
1. Lambda CloudWatchログを確認
2. フィードデータベースが正しくロードされているか確認
3. 入力パラメータが正しいか確認
4. IAM権限を確認

#### フォールバックが動作しない
1. エラーハンドリングが実装されているか確認
2. ログにエラーが記録されているか確認
3. 静的マッピングが正しく実装されているか確認

### 禁止事項

- ❌ テストせずにデプロイする
- ❌ エラーハンドリングを省略する
- ❌ ログ記録を省略する
- ❌ フォールバック機構を実装しない
- ❌ タイムアウト設定を忘れる

### 推奨事項

- ✅ 各タスク完了後に確認項目をチェック
- ✅ ローカルでテストしてからデプロイ
- ✅ CloudWatchログを常に監視
- ✅ エラーは詳細にログに記録
- ✅ パフォーマンスメトリクスを測定

## 理由

Bedrock Agent統合は複数のAWSサービスを連携させる複雑な機能です。段階的に実装し、各ステップで確認することで、問題を早期に発見し、安定した統合を実現します。

# 実装計画

## 概要

この実装計画は、Bedrock Agent 統合を個別の管理可能なタスクに分解します。各タスクは前のステップの上に段階的に構築され、孤立したコードなしで機能が適切に統合されることを保証します。

## タスク

- [x] 1. Lambda 関数とフィードデータベースの作成

  - Lambda 関数のディレクトリ構造を作成
  - Node.js でフィード検索ハンドラーを実装
  - 20 件以上のフィードを含む厳選されたフィードデータベース JSON を作成
  - 関連度スコアリングアルゴリズムを実装
  - 入力検証とエラーハンドリングを追加
  - **確認**: Lambda 関数をローカルでテスト実行し、正しいレスポンスが返ることを確認
  - _要件: 1.1, 1.2, 1.3, 4.1, 4.2, 4.3, 5.1, 5.2, 5.3, 5.4, 8.1, 8.2, 8.3, 8.4, 8.5_

- [x] 2. Bedrock Agent Terraform モジュールの作成

  - Terraform モジュールのディレクトリ構造を作成
  - モジュールの変数と出力を定義
  - CloudWatch 権限を持つ Lambda IAM ロールを作成
  - Lambda 関数を zip ファイルとしてパッケージ化
  - Lambda 関数リソースをデプロイ
  - **確認**: `terraform plan`を実行してエラーがないことを確認
  - _要件: 3.1, 3.2_

- [x] 3. Bedrock Agent と Action Group の設定

  - Claude 3 Haiku で Bedrock Agent リソースを作成
  - フィード検索用のエージェント指示を定義
  - フィード検索アクション用の API スキーマを作成
  - Lambda executor で Action Group を作成
  - モデルと Lambda 権限を持つ Bedrock Agent IAM ロールを作成
  - Bedrock Agent 呼び出し用の Lambda 権限を追加
  - Bedrock Agent 用の本番エイリアスを作成
  - **確認**: `terraform plan`で Bedrock Agent リソースが正しく定義されていることを確認
  - _要件: 3.1, 3.2, 3.3, 3.4, 3.5_

- [x] 4. 本番環境への Bedrock Agent 統合

  - 本番 Terraform に Bedrock Agent モジュールを追加
  - Lambda 用の環境変数を設定
  - Lambda 実行ロールに Bedrock 権限を追加
  - Agent ID と Alias ID を出力
  - Terraform 変更を適用
  - **確認**: `terraform apply`後、AWS Console で Bedrock Agent が正常に作成されていることを確認
  - **確認**: `terraform output`で Agent ID と Alias ID が出力されることを確認
  - _要件: 3.1, 3.2, 7.1, 7.2, 7.3_

- [x] 5. Bedrock 統合で Feed Service を更新

  - サービス設定に Bedrock 設定を追加
  - getFeedRecommendationsFromBedrock メソッドを実装
  - GetFeedRecommendations を更新して最初に Bedrock を試行
  - エラー時の静的マッピングへのフォールバックを実装
  - タイムアウト処理を追加（10 秒）
  - Bedrock レスポンスを model.Feed に変換
  - **確認**: `go vet ./...`と`go test ./...`を実行してエラーがないことを確認
  - _要件: 1.1, 1.5, 2.1, 2.2, 2.3, 2.4, 2.5, 7.1, 7.2, 7.3, 7.4_

- [x] 6. 包括的なログの追加

  - キーワード付きで Bedrock 呼び出しをログ記録
  - フィード数とレイテンシを含む成功レスポンスをログ記録
  - エラー詳細を含むフォールバック使用をログ記録
  - パフォーマンスメトリクスをログ記録
  - 監視用の構造化ログを追加
  - **確認**: ログ出力を確認し、必要な情報がすべて記録されていることを確認
  - _要件: 2.2, 2.4, 6.1, 6.2, 6.3, 6.4, 6.5_

- [x] 7. 統合のデプロイとテスト

  - Bedrock 変更を含む Docker イメージをビルドしてプッシュ
  - Lambda 関数の更新をデプロイ
  - AWS CLI 経由で Bedrock Agent を直接テスト
  - API 経由でフィード推奨をテスト
  - フォールバック機構が動作することを確認
  - CloudWatch ログを監視
  - **確認**: Bedrock Agent が正常にフィードを返すことを確認
  - **確認**: Bedrock エラー時にフォールバックが動作することを確認
  - **確認**: レスポンス時間が要件（10 秒以内）を満たすことを確認
  - _要件: 1.1, 1.2, 1.3, 1.4, 1.5, 2.1, 2.3_

- [ ]\* 8. 監視とアラートの追加

  - Bedrock メトリクス用の CloudWatch ダッシュボードを作成
  - エラー率とレイテンシのアラームを設定
  - Log Insights クエリを設定
  - 監視セットアップをドキュメント化
  - _要件: 2.2, 6.1, 6.2, 6.3, 6.4, 6.5_

- [x] 9. フィード自動登録機能の実装

  - Feed Service に AutoRegisterFeeds メソッドを実装
  - AutoRegisterResult データ構造を定義
  - フィード検証と重複チェックロジックを実装
  - 並列処理でフィード追加を最適化
  - エラーハンドリングとロギングを追加
  - **確認**: ユニットテストを作成し、正常系とエラー系をテスト
  - **確認**: `go test ./...`がすべてパスすることを確認
  - _要件: 9.1, 9.2, 9.3, 9.4, 9.5_

- [x] 10. フィード自動登録 API エンドポイントの追加

  - Feed Handler に AutoRegisterFeeds エンドポイントを追加
  - リクエスト/レスポンス構造を定義
  - 入力検証を実装（max_feeds: 1-10）
  - エンドポイントをルーターに登録
  - API ドキュメントを更新
  - **確認**: Postman/curl でエンドポイントをテスト
  - **確認**: 推奨フィードが正しく Bower に追加されることを確認
  - _要件: 9.1, 9.2, 9.3, 9.4, 9.5_

- [x] 11. Bower 作成時の自動登録機能の実装

  - CreateBowerRequest に auto_register_feeds フラグを追加
  - CreateBowerRequest に max_auto_feeds パラメータを追加（デフォルト 5）
  - CreateBowerResult に自動登録結果を追加
  - Bower 作成後に Feed Service の AutoRegisterFeeds を呼び出し
  - 自動登録エラーを非ブロッキングで処理
  - **確認**: Bower 作成時にフィードが自動登録されることを確認
  - **確認**: 自動登録失敗時も Bower が正常に作成されることを確認
  - _要件: 10.1, 10.2, 10.3, 10.4, 10.5_

- [x] 12. フロントエンドの更新

  - Bower 作成フォームに「フィードを自動登録」チェックボックスを追加 (チェック済)
  - フィード自動登録 API を呼び出す関数を実装
  - 自動登録結果を表示する UI を追加
  - ローディング状態とエラーハンドリングを実装
  - **確認**: UI からフィード自動登録が正常に動作することを確認
  - _要件: 9.1, 10.1_

- [ ] 13. 統合テストとドキュメント

  - エンドツーエンドの統合テストを作成
  - API ドキュメントを更新
  - ユーザーガイドを作成
  - パフォーマンステストを実施
  - **確認**: すべてのテストがパスすることを確認
  - **確認**: ドキュメントが完全で正確であることを確認
  - _要件: 9.1, 9.2, 9.3, 9.4, 9.5, 10.1, 10.2, 10.3, 10.4, 10.5_
